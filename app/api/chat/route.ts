// Using native fetch instead of OpenAI SDK to avoid environment issues

// Comprehensive knowledge base about Mehak Garg - SOURCED FROM ACTUAL DOCUMENTS
const KNOWLEDGE_BASE = `
# MEHAK GARG - PROFESSIONAL PROFILE

## CONTACT INFORMATION
Phone: +1 (628) 358-5515
Email: mehak98garg@gmail.com
Location: San Francisco, CA
LinkedIn: [Profile Link]
Portfolio: [Portfolio Link]

## ABOUT
Product Designer with 4+ years' experience. Expert at designing responsive systems for mobile and desktop. Collaborates comfortably with interdisciplinary partners like engineers, product managers, and UX Researchers to drive complete product development.

## EDUCATION
- California College of the Arts, San Francisco, California (2024-2025) - Master of Design, Interaction Design
- Symbiosis International University, Pune, India (2016-2020) - Bachelor of Design, Fashion Communication, Major in Branding

## CURRENT ROLE
Product Design Intern at Reacher (Y Combinator Backed Startup) - San Francisco (Oct 2023 - Present, Remote)
- Building the #1 AI platform that is scaling and transforming how brands accelerate their social commerce growth
- Designing outreach, engagement, and retainer workflows; targeting 20% increase in long-term creator relationships
- Challenge: Change Management - The redesign introduced a more structured and opinionated workflow
- Results: Reduced steps to create automations, expected 30% reduction in churn while creating automations

## WORK EXPERIENCE

### Tira Beauty (Reliance Industries Limited) - Product Designer
Mumbai, India / Mar 2023 - Jul 2024 / Hybrid Role
- Built and launched a cross-platform B2C e-commerce platform by translating retail problems into impactful user experiences; leading to 2M active users within 6 months – 4x the industry benchmark for a new beauty platform
- Launched 'TopShelf,' an editorial platform designed to elevate engagement and content driven purchases; increased its discoverability through improved layout and hierarchy that boosted purchases and repeat orders by 70%
- Led the design of the Tira Treats' loyalty program, from concepting to prototyping to execution, strengthening customer adoption, designing reward-based features; resulting in a 4.6% increase in user retention post-launch
- Optimized the checkout journey using data from the Research Team; increasing average order value by 8% in a month
- Led the development of a scalable design system compliant with WCAG; enhancing team productivity across workflows

According to Wais Akbari (Head of Design, Tira Beauty): "Mehak joined our team as a junior product designer and quickly demonstrated a rare combination of analytical prowess and design expertise. Her ability to approach design challenges with a thoughtful and strategic mindset has significantly contributed to the success of our projects. She consistently showcased a deep understanding of design principles, coupled with a keen sense of aesthetics."

"One of Mehak's standout qualities is her analytical approach to design. She possesses the ability to dissect complex problems, conduct thorough research, and derive insightful conclusions. She can respectfully question certain decisions, in favour of improving the user experience."

"She has shown her multidisciplinary skills throughout the whole process, from the concept phase until the launch of the product. She demonstrated great resilience by exploring multiple design directions and handling feedback from senior stakeholders, to deliver a state-of-the-art loyalty program. Her performance for this was outstanding and was comparable to a senior product designer, which was recognized within the company and landed her a promotion. The significance of this can be measured, as this will be rolled out to 20 million users in the first year."

### Freelance Designer - Mumbai, India
Jul 2022 - Oct 2022 / Remote Role
- Designed a brand identity for 'Triumbh Entertainment', capturing their unique storytelling approach
- Branded fuel trucks for 'The Fuel Delivery', with promotional graphics that drove 1,000+ app installs

### Multi-Disciplinary Designer at Designflyover Consulting LLP - Mumbai, India
Aug 2020 - Jun 2022 / Remote Role
- Led UI design for 'Skewb', a B2B analytics platform, transforming data into dashboards through data visualization; built high-fidelity wireframes and prototypes to demonstrate interactivity; empowered businesses to optimize budgets
- Developed a wayfinding system for the Indian Institute of Technology, conducting journey mapping and video ethnographies during COVID to optimize walking routes, signage placement and visual language for navigation across 200 acres
- Designed a book on Madhubani art; interviewed 20 artists and art history professors, and used infographics to make historical knowledge relatable through compelling visual storytelling — establishing a global reference for the art form

According to Shreya Sarda (Co-Founder, Designflyover): "Mehak is driven by a great passion for producing flawless work. She puts particular importance on the research phase of her projects which sets her apart from the rest of the 15 designers at the firm. In addition, she ensures that her design decisions are always backed by sound logic and reasoning."

"Despite this, Mehak produced outstanding results in her work. She conducted research through videos of the campus, along with intensive discussions and interviews with the professors and students on campus. The project was completed with great proficiency from her end, leaving the client and our company extremely pleased with the outcome."

"Despite being an impressive designer in her domain, Mehak never shied away from seeking opinions from fellow designers. She accepted suggestions from design engineers, product designers, and even content writers during her design process. Her collaborative approach to solving design problems ensured holistic and fool-proof solutions in her work."

### Design Intern at Thought Over Design
Dec 2019 - Mar 2020 / Remote Role
- Led branding for India's most transformative consumer-facing companies, including Wadhwani AI and The Whole Truth

## AI TOOLKIT
Cursor, Lovable, Bolt, V0 (Vercel), Claude Artifacts, Framer AI, Adobe Firefly, Midjourney, Gamma AI, Zerowidth AI

## AWARDS
- DNA Paris Design Awards 2025 - Winner, Graphic Design: Apps for Project ASTR
- The Print Awards 2025 - 3rd Place, Website & App Design for Project ASTR

## PROJECT HIGHLIGHTS

### Project ASTR (Graduate School Project)
- Created an app that makes space exploration accessible and engaging through the power of astrophotography
- Users can swipe, tap, and uncover an infinite collection of space images with information that translates scientific jargon into relatable narratives
- Utilized gamification to build a community around space exploration
- Won 2 design awards (DNA Paris and Print Award)

## PERSONALITY & WORK STYLE (from Manual on Mehak as a Teammate)

### Quirks
- Hyper-Organized
- Risk Appetite: 8.5/10

### Clifton Strengths
Woo, Analytical, Responsibility, Individualization, Communication

### Strengths
- Not afraid of challenges or hard work
- Practical in approach and calm in dealing with friction
- Excellent soft skills and good hand at visual design
- Gives critique with actionable insights

### Weaknesses
- Doesn't perform best in isolation
- Keeps emotions to myself
- Limited patience for misalignment

### Likes As Co-Worker
- Openly sharing ideas & skills for team growth
- Clear communication of expectations
- Eagerness to take on challenges

### Dislikes As Co-Worker
- Dishonesty
- Gate-keeping resources from the team
- Lack of proactiveness in communication

### Communication Style
- Gives actionable feedback
- Communicates with respect and empathy
- Arguments backed by logic & reasoning

### Conflict Resolution
- Takes a break to cool down
- Calmly discusses both POVs

### Leadership Style
Supportive & Trusting

### Goal Companies
Apple and Spotify

### Dream Project
"My dream is to work on a project that, once people start using it, makes them think, 'How did we ever live without this?'—much like how we now wonder how we ever got around without Google Maps."

## ACADEMIC ACHIEVEMENTS (from Letter of Recommendation - Dr. Neetu Singh, Assistant Professor, Symbiosis)

"I vividly remember Mehak being one of the most engaging and inquisitive students in my class, and always initiated insightful discussions. She can quickly grasp concepts, exhibiting a tremendous quest for knowledge. When it comes to such high pressure situations, Mehak is relentless in her approach. She manages her time in a way that maximizes productivity."

"She chose to work on a branding & packaging project for a hypothetical cafe-cum-performing arts space set up by 'Humans of Bombay'. She did a fantastic job in conceptualizing and developing the brand's extension. On sharing this project with the Humans of Bombay team, the founder reached out to her, appreciating how her visualization and execution were perfectly in line with the brand values."

"During her final assessment, her work and its presentation thoroughly impressed the jury panel. Mr. Paresh Choudhary, the chairman of 'The Odisha Design Council,' offered her to join his team for a design internship."

"Mehak has a natural flair for networking. She often collaborated with her seniors in their initiatives and projects to be able to learn from their experiences. After graduating and having established herself in the industry, she has always been in touch with our team to connect the successive batches to not just openings at her company, but to other relevant people in the industry as well."

## CAREER JOURNEY (from Interview Prep Document)

"I got into taking up design as a career option was a complete accident. I was really good at art growing up, which is why a lot of people around me told me that because of that design is a great option for me. I did end up taking it and studying. I studied design for 4 years in India, in Pune, post which I bagged a role at a design agency as a multidisciplinary designer, which is when I finally understood that design is actually not about art, it is about the impact that it can make."

"Designing dashboards for a marketing analytics company made me realize that my designs help CMOs and CFOs make decisions that could make or break the business. This realization is what actually made me fall in love with the discipline even more."

"I joined Tira Beauty, India's largest retailer Reliance. I joined them pre-launch when we were just a team of 3 people. I helped them build various features like their onboarding experience, their loyalty program, and check out flow right from the ground up. And within the 1st 6 months, we reached 2 million active users."

"I realized that design in India as a discipline was still slightly misunderstood. It was more about the pixels and less about the impact that it made. So to push my limits as a designer, I wanted to come to the design and tech hub of the world, which, of course, is San Francisco and I chose to do my master's here in interaction design at California College of Arts."

## WHAT MEHAK WANTS IN HER NEXT ROLE

"For my new role, I definitely want to be in a space where the company is striving to solve a genuine problem area or gap in its industry. I want my next role to empower me to channelise my skills and mindset as a designer to really solve for that problem area. With AI in the picture now, I also want my next role to keep me ahead of the curve with all innovations on that front."

"One of the things I value most in a manager is mutual trust. In high stake environments I realised that it's an important quality to have. I'm a sincere professional and I would want my mentor to trust my capabilities. Being a designer also involves advocating for your designs often, in which case I would want a mentor who can stand by me and my design decisions."

## BLIND SPOTS & AREAS FOR GROWTH

"In my professional experience so far, I haven't had a chance to work on inclusive, accessible design. In my previous roles, we were so focused on shipping quickly that I never really learned about designing for people with disabilities. Things like Visual Accessibility, Focus indicators, Scalable text etc are not things that I've been able to explore in the past and I would love to learn about it more and hopefully implement them in my designs someday."

## CURIOSITY

"AI has advanced enough for us to know how it might impact certain roles in the future. But with the design tools that are coming up like lovable or bolt, I still feel like there isn't a clear answer to what that means for designers of today. My personal opinion on this is that designers so far are known for the tool that they use and not the problem solving mindset that they have. And AI will do us a favour by taking over the cumbersome work of perfecting pixels using different tools. Instead I feel like it'll place designers into more strategic roles, where we can truly utilise design thinking."
`;

export async function POST(req: Request) {
  try {
    const { messages } = await req.json()

    if (!messages || !Array.isArray(messages) || messages.length === 0) {
      return new Response(
        JSON.stringify({ error: 'Messages array is required' }),
        { status: 400 }
      )
    }

    // Validate API key
    const apiKey = process.env.OPENAI_API_KEY
    
    console.log('[v0] API key exists:', !!apiKey)
    console.log('[v0] API key type:', typeof apiKey)
    console.log('[v0] API key starts with sk:', apiKey?.startsWith('sk'))
    
    if (!apiKey) {
      console.error('[v0] OPENAI_API_KEY is not set')
      return new Response(
        JSON.stringify({ 
          error: 'OpenAI API key not configured',
          details: 'OPENAI_API_KEY environment variable is missing'
        }),
        { status: 500, headers: { 'Content-Type': 'application/json' } }
      )
    }

    if (typeof apiKey !== 'string' || apiKey.trim() === '') {
      console.error('[v0] OPENAI_API_KEY is invalid:', typeof apiKey)
      return new Response(
        JSON.stringify({ 
          error: 'OpenAI API key is invalid',
          details: 'OPENAI_API_KEY must be a non-empty string'
        }),
        { status: 500, headers: { 'Content-Type': 'application/json' } }
      )
    }

    // System prompt that uses the knowledge base
    const systemPrompt = `You are an AI agent representing the personal and professional background of Mehak Garg, providing recruiters with accurate and compelling insights.

VERIFIED KNOWLEDGE BASE:
${KNOWLEDGE_BASE}

RESPONSE GUIDELINES:

For Professional Questions (Experience, Skills, Projects, Leadership):
- Use verbatim data from the resume for accuracy
- Prioritize Mehak's experience as a product designer above all
- Quote information in double quotes from Letters of Recommendation whenever asked about work experience
- When mentioning past employers, extract relevant testimonials or feedback from the Letters of Recommendation
- Ensure that any quoted text explicitly attributes the statement to the recommender where possible (e.g., "According to [Recommender's Name], Mehak...")
- If no recommender name is available, state "As noted in a letter of recommendation..."
- Always mention company names and project titles explicitly. Do not generalize or omit them
- Include quantitative data whenever available

For Behavioral & Cultural Questions:
- Emphasize personality and motivation to ensure cultural alignment
- Reference specific traits from the "Manual on Mehak as a Teammate" section

RESPONSE STYLE:
- Short, crisp, and informative answers. Avoid lengthy responses
- Use a formal yet warm tone
- Avoid using industry buzzwords like "intuitive", "empathetic" and "human-centred" - use more contextual and specific words
- Maintain structured responses with bullet points and clear formatting

IMPORTANT RULES:
- When answering professional experience questions, if a company name, project title or quantitative data is available in the dataset, you must include it in the response verbatim
- Do not omit or replace specific details with generic descriptions
- Only provide verifiable answers
- If there is no verifiable information, state that you don't know and redirect the conversation back to talking about her work experience

Current conversation:`

    console.log('[v0] Calling OpenAI API with fetch...')

    // Call OpenAI API directly with fetch
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey.trim()}`,
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          { role: 'system', content: systemPrompt },
          ...messages.map((msg: any) => ({
            role: msg.role,
            content: msg.content,
          })),
        ],
        temperature: 0.7,
        max_tokens: 500,
        stream: true,
      }),
    })

    if (!response.ok) {
      const errorData = await response.json()
      console.error('[v0] OpenAI API error:', errorData)
      throw new Error(`OpenAI API error: ${errorData.error?.message || response.statusText}`)
    }

    console.log('[v0] Streaming response from OpenAI...')

    // Stream the response back to the client
    const readableStream = new ReadableStream({
      async start(controller) {
        const reader = response.body?.getReader()
        const decoder = new TextDecoder()

        if (!reader) {
          controller.error(new Error('No response body'))
          return
        }

        try {
          while (true) {
            const { done, value } = await reader.read()
            if (done) break

            const chunk = decoder.decode(value, { stream: true })
            const lines = chunk.split('\n').filter(line => line.trim() !== '')

            for (const line of lines) {
              if (line.startsWith('data: ')) {
                const data = line.slice(6)
                if (data === '[DONE]') continue

                try {
                  const json = JSON.parse(data)
                  const content = json.choices[0]?.delta?.content || ''
                  if (content) {
                    controller.enqueue(new TextEncoder().encode(content))
                  }
                } catch (e) {
                  console.error('[v0] Parse error:', e)
                }
              }
            }
          }
          controller.close()
        } catch (error) {
          console.error('[v0] Stream error:', error)
          controller.error(error)
        }
      },
    })

    return new Response(readableStream, {
      headers: {
        'Content-Type': 'text/plain; charset=utf-8',
        'Transfer-Encoding': 'chunked',
      },
    })
  } catch (error: any) {
    console.error('[v0] Chat API error:', error)
    return new Response(
      JSON.stringify({ 
        error: 'Failed to generate response', 
        details: error.message 
      }),
      { status: 500, headers: { 'Content-Type': 'application/json' } }
    )
  }
}
